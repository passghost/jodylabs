<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Gibbing Sets — Buildings 2×3 + Jungle 2×6 (HTML-only)</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  :root { --unit: 128px; }
  * { box-sizing: border-box; }
  body{
    margin:0; min-height:100vh; display:flex; flex-direction:column; gap:32px; align-items:center;
    background:#0f0f12; color:#cfd3da; font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;
  }
  h2{ margin:18px 0 8px; font-weight:700; color:#e6e8ee; }
  .wrap{ width:min(1200px, 95vw); padding:18px; background:#171920; border-radius:14px; box-shadow:0 6px 30px rgba(0,0,0,.45), inset 0 0 0 1px #282b35; }
  .hint{ font-size:12px; opacity:.65; margin-bottom:10px; }
  .grid{
    display:grid; grid-template-columns: repeat(3, var(--unit));
    grid-template-rows: repeat(2, var(--unit));
    gap: 14px;
  }
  .cell{
    width:var(--unit); height:var(--unit);
    border-radius:10px; overflow:hidden; position:relative;
    box-shadow: inset 0 0 0 1px #2b2f3b, 0 2px 10px rgba(0,0,0,.35);
    background:#1a1d25; cursor:pointer;
  }
  svg{ width:100%; height:100%; display:block; image-rendering:pixelated; shape-rendering:crispEdges; }
  .cell canvas{ position:absolute; inset:0; width:100%; height:100%; image-rendering:pixelated; }
  .toolbar{ display:flex; gap:8px; margin-top:8px; }
  button{
    background:#242733; color:#e3e6ef; border:1px solid #2c3040; border-radius:8px; padding:6px 10px; cursor:pointer;
  }
  button:hover{ background:#2a2e3d; }
  /* Jungle canvas */
  #jungle{
    image-rendering: pixelated;
    image-rendering: crisp-edges;
    width: min(95vw, 1160px);
    height: min(60vw, 620px);
    background: #0b0d0e radial-gradient(80% 140% at 50% 0%, rgba(50,120,90,.15), rgba(0,0,0,0));
    display: block;
    border-radius: 12px;
    box-shadow: inset 0 0 0 1px #26262e;
    outline:none;
  }
</style>
</head>
<body>

<div class="wrap">
  <h2>Buildings — 2×3 (Click a tile to Gib)</h2>
  <div class="hint">Each tile rasterizes to pixels and explodes into 2×2 chunks with outward force, gravity, and fade.</div>
  <div class="grid" id="buildingsGrid">

    <!-- 1) Red shingled house -->
    <figure class="cell" data-name="Red shingled house">
      <svg viewBox="0 0 64 64" aria-label="Red shingled house">
        <rect width="64" height="64" fill="#7fb36a"/>
        <rect x="3" y="5" width="2" height="2" fill="#73a860"/>
        <rect x="10" y="18" width="2" height="2" fill="#6da35b"/>
        <rect x="22" y="10" width="2" height="2" fill="#6fa55d"/>
        <rect x="40" y="22" width="2" height="2" fill="#6aa159"/>
        <rect x="52" y="8" width="2" height="2" fill="#6aa159"/>
        <rect x="10" y="28" width="44" height="28" fill="#00000022"/>
        <rect x="12" y="18" width="40" height="34" fill="#d4c7a1"/>
        <rect x="12" y="18" width="40" height="2" fill="#c3b591"/>
        <rect x="12" y="50" width="40" height="2" fill="#b7aa8a"/>
        <rect x="8" y="10" width="48" height="12" fill="#b8443f"/>
        <g fill="#a83e3a">
          <rect x="8" y="13" width="48" height="1"/>
          <rect x="8" y="16" width="48" height="1"/>
          <rect x="8" y="19" width="48" height="1"/>
        </g>
        <rect x="8" y="11" width="48" height="1" fill="#cc544e"/>
        <rect x="44" y="6" width="6" height="6" fill="#8c6b53"/>
        <rect x="44" y="6" width="6" height="1" fill="#9e7a60"/>
        <g>
          <rect x="16" y="26" width="8" height="8" fill="#6fb2e5"/>
          <rect x="40" y="26" width="8" height="8" fill="#6fb2e5"/>
          <rect x="16" y="26" width="8" height="1" fill="#a6d3f3"/>
          <rect x="40" y="26" width="8" height="1" fill="#a6d3f3"/>
          <rect x="20" y="26" width="1" height="8" fill="#4d88ab"/>
          <rect x="44" y="26" width="1" height="8" fill="#4d88ab"/>
        </g>
        <rect x="30" y="34" width="8" height="18" fill="#7a4d2f"/>
        <rect x="30" y="34" width="8" height="1" fill="#8a5a3a"/>
        <rect x="36" y="43" width="1" height="2" fill="#d1b06f"/>
        <g fill="#bdb9ae">
          <rect x="31" y="54" width="6" height="2"/>
          <rect x="31" y="58" width="6" height="2"/>
        </g>
        <rect x="54" y="38" width="6" height="8" fill="#6d513e"/>
        <rect x="54" y="38" width="6" height="1" fill="#7b5d48"/>
        <rect x="55" y="39" width="4" height="2" fill="#4689b9"/>
      </svg>
    </figure>

    <!-- 2) Blue slate cottage -->
    <figure class="cell" data-name="Blue slate cottage">
      <svg viewBox="0 0 64 64" aria-label="Blue slate cottage">
        <rect width="64" height="64" fill="#79b060"/>
        <rect x="6" y="8" width="2" height="2" fill="#6aa159"/>
        <rect x="22" y="16" width="2" height="2" fill="#6aa159"/>
        <rect x="50" y="20" width="2" height="2" fill="#6aa159"/>
        <rect x="8" y="30" width="44" height="26" fill="#00000022"/>
        <rect x="10" y="42" width="44" height="10" fill="#926a42"/>
        <rect x="10" y="42" width="44" height="1" fill="#a97a4d"/>
        <rect x="12" y="20" width="40" height="26" fill="#e0d9c4"/>
        <rect x="9" y="10" width="46" height="12" fill="#3f5876"/>
        <g fill="#374d69">
          <rect x="9" y="13" width="46" height="1"/>
          <rect x="9" y="16" width="46" height="1"/>
          <rect x="9" y="19" width="46" height="1"/>
        </g>
        <g>
          <rect x="16" y="24" width="8" height="8" fill="#a2d5ff"/>
          <rect x="40" y="24" width="8" height="8" fill="#a2d5ff"/>
          <rect x="20" y="24" width="1" height="8" fill="#78a6c7"/>
          <rect x="44" y="24" width="1" height="8" fill="#78a6c7"/>
        </g>
        <rect x="30" y="28" width="8" height="18" fill="#6e3e2b"/>
        <rect x="30" y="44" width="8" height="2" fill="#5f3726"/>
        <rect x="29" y="46" width="10" height="2" fill="#b7a88e"/>
        <rect x="28" y="48" width="12" height="2" fill="#a4967c"/>
        <rect x="35" y="37" width="1" height="2" fill="#d9c07c"/>
        <rect x="12" y="42" width="2" height="10" fill="#7f5a39"/>
        <rect x="50" y="42" width="2" height="10" fill="#7f5a39"/>
      </svg>
    </figure>

    <!-- 3) Brown thatch hut -->
    <figure class="cell" data-name="Brown thatch hut">
      <svg viewBox="0 0 64 64" aria-label="Brown thatch hut">
        <rect width="64" height="64" fill="#78ad5e"/>
        <rect x="4" y="6" width="2" height="2" fill="#6aa159"/>
        <rect x="42" y="10" width="2" height="2" fill="#6aa159"/>
        <rect x="12" y="32" width="46" height="24" fill="#00000022"/>
        <g fill="#bcb7aa">
          <rect x="14" y="18" width="4" height="2"/>
          <rect x="46" y="18" width="4" height="2"/>
          <rect x="12" y="22" width="2" height="2"/>
          <rect x="52" y="22" width="2" height="2"/>
        </g>
        <rect x="14" y="22" width="36" height="26" fill="#cbb089"/>
        <rect x="28" y="30" width="8" height="18" fill="#724a2e"/>
        <rect x="34" y="38" width="1" height="2" fill="#e3c586"/>
        <rect x="10" y="14" width="44" height="10" fill="#a98547"/>
        <g fill="#997a40">
          <rect x="10" y="16" width="44" height="1"/>
          <rect x="10" y="18" width="44" height="1"/>
          <rect x="10" y="20" width="44" height="1"/>
        </g>
        <rect x="30" y="16" width="4" height="4" fill="#7fb7e6"/>
        <rect x="30" y="16" width="4" height="1" fill="#9ed0f5"/>
        <rect x="14" y="22" width="1" height="26" fill="#a17a58"/>
        <rect x="49" y="22" width="1" height="26" fill="#a17a58"/>
      </svg>
    </figure>

    <!-- 4) Stone house with green roof -->
    <figure class="cell" data-name="Stone house with green roof">
      <svg viewBox="0 0 64 64" aria-label="Stone house with green roof">
        <rect width="64" height="64" fill="#80b467"/>
        <rect x="16" y="30" width="40" height="26" fill="#00000022"/>
        <rect x="14" y="18" width="36" height="28" fill="#c9c9c9"/>
        <g fill="#b6b6b6">
          <rect x="16" y="20" width="6" height="3"/>
          <rect x="24" y="21" width="8" height="3"/>
          <rect x="34" y="20" width="6" height="3"/>
          <rect x="42" y="22" width="6" height="3"/>
          <rect x="18" y="26" width="8" height="3"/>
          <rect x="30" y="26" width="6" height="3"/>
          <rect x="40" y="26" width="8" height="3"/>
          <rect x="16" y="32" width="6" height="3"/>
          <rect x="26" y="32" width="10" height="3"/>
          <rect x="40" y="32" width="8" height="3"/>
        </g>
        <rect x="12" y="10" width="40" height="10" fill="#2f7d69"/>
        <g fill="#2a6f5e">
          <rect x="12" y="12" width="40" height="1"/>
          <rect x="12" y="14" width="40" height="1"/>
          <rect x="12" y="16" width="40" height="1"/>
          <rect x="12" y="18" width="40" height="1"/>
        </g>
        <rect x="12" y="10" width="40" height="1" fill="#3a8f7a"/>
        <rect x="18" y="24" width="8" height="8" fill="#a9dcff"/>
        <rect x="38" y="24" width="8" height="8" fill="#a9dcff"/>
        <rect x="22" y="24" width="1" height="8" fill="#7cb0cc"/>
        <rect x="42" y="24" width="1" height="8" fill="#7cb0cc"/>
        <rect x="28" y="30" width="8" height="16" fill="#6a4631"/>
        <rect x="33" y="38" width="1" height="2" fill="#d6c48a"/>
        <rect x="18" y="33" width="8" height="2" fill="#7b5a3d"/>
        <rect x="18" y="31" width="8" height="2" fill="#9bd27d"/>
        <rect x="38" y="33" width="8" height="2" fill="#7b5a3d"/>
        <rect x="38" y="31" width="8" height="2" fill="#9bd27d"/>
      </svg>
    </figure>

    <!-- 5) Long barn -->
    <figure class="cell" data-name="Long barn">
      <svg viewBox="0 0 64 64" aria-label="Long barn with orange tiles">
        <rect width="64" height="64" fill="#76aa5d"/>
        <rect x="8" y="34" width="48" height="22" fill="#00000022"/>
        <rect x="8" y="22" width="48" height="24" fill="#caa071"/>
        <rect x="12" y="28" width="10" height="14" fill="#7d4f34"/>
        <rect x="42" y="28" width="10" height="14" fill="#7d4f34"/>
        <rect x="21" y="35" width="1" height="2" fill="#d8c28b"/>
        <rect x="51" y="35" width="1" height="2" fill="#d8c28b"/>
        <rect x="6" y="12" width="52" height="10" fill="#c76a27"/>
        <g fill="#b85f22">
          <rect x="6" y="14" width="52" height="1"/>
          <rect x="6" y="16" width="52" height="1"/>
          <rect x="6" y="18" width="52" height="1"/>
        </g>
        <rect x="26" y="28" width="12" height="6" fill="#89c7f4"/>
        <rect x="26" y="28" width="12" height="1" fill="#a9dafb"/>
        <rect x="30" y="40" width="6" height="4" fill="#e9d27a"/>
        <rect x="32" y="39" width="2" height="1" fill="#fff2a0"/>
      </svg>
    </figure>

    <!-- 6) Teal cabin -->
    <figure class="cell" data-name="Teal cabin">
      <svg viewBox="0 0 64 64" aria-label="Teal cabin with deck">
        <rect width="64" height="64" fill="#77ac60"/>
        <rect x="14" y="34" width="40" height="22" fill="#00000022"/>
        <rect x="12" y="42" width="40" height="10" fill="#7b5a3c"/>
        <rect x="12" y="42" width="40" height="1" fill="#8c6847"/>
        <rect x="16" y="22" width="32" height="20" fill="#3d8b8b"/>
        <rect x="16" y="22" width="32" height="2" fill="#479898"/>
        <rect x="16" y="40" width="32" height="2" fill="#347c7c"/>
        <rect x="14" y="14" width="36" height="8" fill="#30515f"/>
        <g fill="#2a4753">
          <rect x="14" y="16" width="36" height="1"/>
          <rect x="14" y="18" width="36" height="1"/>
        </g>
        <rect x="28" y="28" width="8" height="14" fill="#6a4833"/>
        <rect x="20" y="28" width="6" height="6" fill="#a6ddff"/>
        <rect x="20" y="28" width="6" height="1" fill="#c0e9ff"/>
        <rect x="35" y="35" width="1" height="2" fill="#d8c07c"/>
        <rect x="14" y="42" width="2" height="10" fill="#6f5137"/>
        <rect x="50" y="42" width="2" height="10" fill="#6f5137"/>
        <rect x="46" y="46" width="4" height="2" fill="#8a673f"/>
        <rect x="50" y="46" width="4" height="2" fill="#8a673f"/>
        <rect x="48" y="44" width="4" height="2" fill="#8a673f"/>
      </svg>
    </figure>

  </div>
  <div class="toolbar">
    <button id="gibAllBuildings">Gib all</button>
    <button id="resetBuildings">Reset</button>
  </div>
</div>

<div class="wrap">
  <h2>Jungle Foliage — 2×6 (Click tiles to Gib • G = gib all • R = regrow)</h2>
  <div class="hint">WASD: pan • Move mouse: wind direction • G: gib all • R: regrow all • P: recolor palette</div>
  <canvas id="jungle" width="1200" height="640" aria-label="2x6 jungle foliage grid (gibbing)"></canvas>
</div>

<script>
/* ===========================================================
   BUILDINGS — GIBBING EACH SVG TILE
=========================================================== */
(function(){
  const grid = document.getElementById('buildingsGrid');
  const cells = Array.from(grid.querySelectorAll('.cell'));
  const TILE_SRC_SIZE = 64;        // source SVG viewBox
  const SAMPLE = 2;                // chunk size (2×2 logical pieces)
  const GRAV = 700;                // px/s² (scaled by display size)
  const DRAG = 0.985;
  const LIFE = 1.4;                // seconds

  cells.forEach(cell=>{
    let exploded = false;

    cell.addEventListener('click', ()=>explode(cell));
    function explode(cell){
      if (exploded) return;
      exploded = true;
      const svg = cell.querySelector('svg');
      if (!svg) return;

      // 1) Rasterize SVG to an Image (64×64 logical)
      const xml = new XMLSerializer().serializeToString(svg);
      const url = 'data:image/svg+xml;charset=utf-8,' + encodeURIComponent(xml);
      const img = new Image();
      img.onload = ()=>{
        // 2) Draw into offscreen canvas to read pixels
        const off = document.createElement('canvas');
        off.width = TILE_SRC_SIZE; off.height = TILE_SRC_SIZE;
        const g = off.getContext('2d', { willReadFrequently:true });
        g.imageSmoothingEnabled = false;
        g.drawImage(img, 0, 0, TILE_SRC_SIZE, TILE_SRC_SIZE);
        const data = g.getImageData(0,0,TILE_SRC_SIZE,TILE_SRC_SIZE).data;

        // 3) Build chunks (2×2) from opaque pixels
        const canvas = document.createElement('canvas');
        const bb = cell.getBoundingClientRect();
        canvas.width = TILE_SRC_SIZE; canvas.height = TILE_SRC_SIZE;
        canvas.style.width = '100%'; canvas.style.height = '100%';
        const ctx = canvas.getContext('2d');
        ctx.imageSmoothingEnabled = false;

        // Hide SVG, insert canvas
        svg.style.display = 'none';
        cell.appendChild(canvas);

        // Particles
        const parts = [];
        const cx = TILE_SRC_SIZE/2, cy = TILE_SRC_SIZE/2;

        for (let y=0; y<TILE_SRC_SIZE; y+=SAMPLE){
          for (let x=0; x<TILE_SRC_SIZE; x+=SAMPLE){
            // Test alpha of block
            const idx = (y*TILE_SRC_SIZE + x)*4;
            if (data[idx+3] < 10) continue;

            // Average the 2×2 block color (simple pick of top-left)
            const r = data[idx], g1 = data[idx+1], b = data[idx+2], a = data[idx+3]/255;

            // Radial blow-out velocity from center + randomness
            const dx = x - cx, dy = y - cy;
            const dist = Math.max(10, Math.hypot(dx,dy));
            const n = { x: dx/dist, y: dy/dist };
            const speed = 220 + Math.random()*220; // px/s
            const vx = n.x*speed + (Math.random()-0.5)*120;
            const vy = n.y*speed + (Math.random()-0.5)*120 - 80; // bias upward a bit

            parts.push({
              x, y, vx, vy, life:LIFE*(0.6+Math.random()*0.6), age:0,
              w:SAMPLE, h:SAMPLE, color:`rgba(${r},${g1},${b},${a})`, spin:(Math.random()-0.5)*10, ang:0
            });
          }
        }

        // 4) Animate
        let last = performance.now();
        (function tick(now){
          const dt = Math.min(0.033, (now-last)/1000); last = now;

          // physics
          parts.forEach(p=>{
            p.vy += GRAV * dt;
            p.vx *= DRAG; p.vy *= DRAG;
            p.x += p.vx*dt; p.y += p.vy*dt;
            p.ang += p.spin*dt;
            p.age += dt;
          });

          // clear
          ctx.clearRect(0,0,canvas.width,canvas.height);

          // draw
          parts.forEach(p=>{
            const t = Math.max(0, 1 - p.age/p.life); // fade
            if (t<=0) return;
            ctx.save();
            ctx.globalAlpha = t;
            ctx.translate(p.x + p.w/2, p.y + p.h/2);
            ctx.rotate(p.ang*0.1);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
            ctx.restore();
          });

          // Stop when all dead
          if (parts.some(p=>p.age < p.life)){
            requestAnimationFrame(tick);
          } else {
            // leave crater-ish shadow
            ctx.globalAlpha = 0.2;
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.ellipse(cx, cy+6, 20, 12, 0, 0, Math.PI*2);
            ctx.fill();
          }
        })(performance.now());
      };
      img.src = url;
    }
  });

  // Toolbar actions
  document.getElementById('gibAllBuildings').onclick = ()=>{
    cells.forEach(c=>c.click());
  };
  document.getElementById('resetBuildings').onclick = ()=>{
    cells.forEach(cell=>{
      const svg = cell.querySelector('svg');
      const cnv = cell.querySelector('canvas');
      if (cnv) cnv.remove();
      if (svg) svg.style.display = '';
    });
  };
})();

/* ===========================================================
   JUNGLE FOLIAGE — SAME GRID + GIBBING PER TILE
=========================================================== */
(function(){
  const canvas = document.getElementById('jungle');
  const ctx = canvas.getContext('2d');
  ctx.imageSmoothingEnabled = false;
  const W = canvas.width, H = canvas.height;

  // Controls (from your prior version)
  const cam = { x: 0, y: 0, speed: 160 };
  const keys = new Set();
  let mouse = { x: W/2, y: H/2 };

  canvas.tabIndex = 0;
  canvas.addEventListener('mousemove', e => {
    const r = canvas.getBoundingClientRect();
    mouse.x = (e.clientX - r.left) * (canvas.width / r.width);
    mouse.y = (e.clientY - r.top)  * (canvas.height / r.height);
  });
  canvas.addEventListener('keydown', e => { keys.add(e.key.toLowerCase()); });
  canvas.addEventListener('keyup', e => { keys.delete(e.key.toLowerCase()); });

  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function randInt(a,b){ return (a + Math.floor(Math.random()*(b-a+1))); }

  function randJunglePalette() {
    const h = 110 + randInt(-15, 25);
    const s = 45 + randInt(-10, 15);
    const l = 22 + randInt(-6, 10);
    return {
      leafDark:  `hsl(${h} ${s+5}% ${clamp(l-6, 8, 60)}%)`,
      leaf:      `hsl(${h} ${s+8}% ${l}%)`,
      leafLight: `hsl(${h} ${s+15}% ${clamp(l+10, 10, 70)}%)`,
      stem:      `hsl(${h-25} ${clamp(s-10,10,70)}% ${clamp(l-10,5,50)}%)`,
      bloom:     `hsl(${(h+260)%360} 60% 65%)`,
      fruit:     `hsl(${(h+90)%360} 70% 55%)`
    };
  }
  let PAL = randJunglePalette();

  const COLS = 6, ROWS = 2;
  const TILE_PX = 96;
  const SCALE = 1.5; // same as 3/2
  const GAP = 8;
  const totalW = COLS * (TILE_PX*SCALE) + (COLS+1)*GAP;
  const totalH = ROWS * (TILE_PX*SCALE) + (ROWS+1)*GAP;
  const startX = (W - totalW)/2;
  const startY = (H - totalH)/2;

  // tile factory (offscreen)
  function makeTileCanvas() {
    const c = document.createElement('canvas');
    c.width = TILE_PX; c.height = TILE_PX;
    const tctx = c.getContext('2d');
    tctx.imageSmoothingEnabled = false;
    return { c, tctx };
  }

  // Minimal primitives used by plant makers
  function px(g,x,y,w=1,h=1,color='#fff'){ g.fillStyle = color; g.fillRect(x|0,y|0,w|0,h|0); }
  function drawLeaf(g, cx, cy, len, width, angle, colMid, colEdge) {
    const steps = Math.max(6, Math.floor(len/3));
    for (let i=0;i<=steps;i++){
      const t = i/steps;
      const w = width*(1 - Math.pow(t,1.5));
      const dx = Math.cos(angle)*len*t;
      const dy = Math.sin(angle)*len*t;
      const x = cx + dx, y = cy + dy;
      px(g, x-w, y, w, 1, colEdge);
      px(g, x, y, 1, 1, colMid);
      px(g, x+1, y, w, 1, colEdge);
    }
  }
  function drawStem(g, x1,y1,x2,y2, col) {
    g.fillStyle = col;
    const steps = Math.hypot(x2-x1,y2-y1)|0;
    for (let i=0;i<=steps;i++){
      const t = i/steps;
      const x = Math.round(x1 + (x2-x1)*t);
      const y = Math.round(y1 + (y2-y1)*t);
      g.fillRect(x, y, 1, 1);
    }
  }

  // A subset of plant makers (12 total)
  function makePalmFronds(tile){
    const { tctx:g } = tile;
    const cx=TILE_PX/2, cy=TILE_PX*0.58;
    const blades = 7;
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      drawStem(g, cx, cy, cx, cy-18, PAL.stem);
      for(let i=0;i<blades;i++){
        const a = -Math.PI/2 + (i-(blades-1)/2)*(Math.PI/10);
        const sway = Math.sin(time*0.004 + i*0.7) * 0.25 + Math.cos(windA - a)*0.2*windMag;
        const ang = a + sway;
        drawLeaf(g, cx, cy-18, 28, 4, ang, PAL.leaf, PAL.leafLight);
      }
    };
  }
  function makeBroadleafCluster(tile){
    const { tctx:g } = tile;
    const cx=TILE_PX/2, cy=TILE_PX*0.62;
    const rings = 4;
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      for(let r=0;r<rings;r++){
        const count = 10 + r*3;
        const rad = 8 + r*5;
        for(let i=0;i<count;i++){
          const a = (i/count)*Math.PI*2;
          const sway = (Math.sin(time*0.003 + r*0.9 + i*0.5)+1)*0.5 * 0.35*windMag;
          const ang = a + sway + (windA - Math.PI/2)*0.05;
          const x = cx + Math.cos(a)*rad;
          const y = cy + Math.sin(a)*rad*0.7 - r;
          drawLeaf(g, x, y, 10+r*2, 2, ang, PAL.leaf, PAL.leafLight);
        }
      }
    };
  }
  function makeFern(tile){
    const { tctx:g } = tile;
    const baseX=TILE_PX*0.52, baseY=TILE_PX*0.68;
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      for(let b=0;b<3;b++){
        const stemLen = 34 - b*6;
        const stemA = -Math.PI/2 + (b-1)*0.25 + Math.sin(time*0.004+b)*0.08 + Math.cos(windA)*0.1*windMag;
        let x=baseX+b*2, y=baseY;
        for(let i=0;i<stemLen;i++){
          x += Math.cos(stemA)/1.6; y += Math.sin(stemA)/1.6;
          px(g,x,y,1,1,PAL.stem);
          if (i>6 && i%2===0){
            const leafA = stemA - Math.PI/2 + (Math.random()*0.1-0.05);
            const leafB = stemA + Math.PI/2 + (Math.random()*0.1-0.05);
            drawLeaf(g, x, y, 6, 1, leafA, PAL.leafDark, PAL.leaf);
            drawLeaf(g, x, y, 6, 1, leafB, PAL.leafDark, PAL.leaf);
          }
        }
      }
    };
  }
  function makeBamboo(tile){
    const { tctx:g } = tile;
    const stalks = [TILE_PX*0.42, TILE_PX*0.55, TILE_PX*0.68];
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      stalks.forEach((sx,i)=>{
        const lean = Math.cos(time*0.003 + i)*0.1 + Math.cos(windA)*0.15*windMag;
        for(let y=TILE_PX*0.75; y>20; y--){
          const xx = sx + (TILE_PX*0.75 - y)*lean*0.03;
          px(g,xx,y,1,1,PAL.stem);
          if (y%10===0) px(g,xx-1,y,3,1,PAL.leafLight);
          if (y%7===0){
            const dir = (i%2?1:-1);
            drawLeaf(g, xx, y, 7, 1, (-Math.PI/2)+dir*0.9, PAL.leaf, PAL.leafLight);
          }
        }
      });
    };
  }
  function makeVines(tile){
    const { tctx:g } = tile;
    const anchors = [20, 40, 60, 78];
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      anchors.forEach((ax,i)=>{
        let x=ax, y=8;
        const length = 70;
        for(let k=0;k<length;k++){
          const sway = Math.sin((k*0.15) + time*0.004 + i)*1.1 + Math.cos(windA)*1.5*windMag;
          x = ax + sway* (k/length);
          y = 8 + k*0.9;
          px(g, x, y, 1, 1, PAL.stem);
          if (k%8===0){
            drawLeaf(g, x, y, 8, 1, Math.PI, PAL.leaf, PAL.leafLight);
            drawLeaf(g, x, y, 8, 1, 0,      PAL.leaf, PAL.leafLight);
          }
        }
      });
    };
  }
  function makeBanana(tile){
    const { tctx:g } = tile;
    const cx=TILE_PX*0.5, cy=TILE_PX*0.7;
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      drawStem(g, cx, cy, cx, cy-16, PAL.stem);
      for(let i=0;i<5;i++){
        const a = -Math.PI/2 + (i-2)*0.22;
        const bend = Math.sin(time*0.003 + i)*0.15 + Math.sin(windA - a)*0.25*windMag;
        drawLeaf(g, cx, cy-16, 36, 5, a + bend, PAL.leafDark, PAL.leafLight);
      }
    };
  }
  function makeBush(tile){
    const { tctx:g } = tile;
    const cx=TILE_PX/2, cy=TILE_PX*0.72;
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      for(let r=0;r<5;r++){
        const rad=10+r*3;
        for(let i=0;i<20;i++){
          const a = (i/20)*Math.PI*2;
          const sway = Math.cos(time*0.002 + i*0.3)*0.2 + Math.cos(windA-a)*0.2*windMag;
          const x=cx+Math.cos(a+ sway)*rad;
          const y=cy+Math.sin(a+ sway)*rad*0.7;
          px(g, x, y, 2, 2, r<2?PAL.leaf:PAL.leafLight);
        }
      }
    };
  }
  function makePhilodendron(tile){
    const { tctx:g } = tile;
    const centers = [ [46,64],[54,72],[60,60],[38,70] ];
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      centers.forEach((c,i)=>{
        const [cx,cy]=c;
        const a = -Math.PI/2 + i*0.9;
        const t = time*0.004 + i;
        const bend = Math.sin(t)*0.18 + Math.cos(windA)*0.22*windMag;
        drawLeaf(g, cx, cy, 24, 5, a+bend, PAL.leaf, PAL.leafLight);
        px(g, cx, cy, 1,1, PAL.stem);
      });
    };
  }
  function makeReeds(tile){
    const { tctx:g } = tile;
    const bases = Array.from({length:9}, (_,i)=>20+i*7);
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      bases.forEach((bx,i)=>{
        const lean = Math.sin(time*0.003 + i)*0.2 + Math.cos(windA)*0.25*windMag;
        for(let y=TILE_PX*0.78; y>18; y--){
          const xx = bx + (TILE_PX*0.78 - y)*lean*0.06;
          px(g,xx,y,1,1,PAL.stem);
          if (y%11===0) drawLeaf(g, xx, y, 7, 1, -Math.PI/2 + (i%2?0.8:-0.8), PAL.leaf, PAL.leafLight);
        }
      });
    };
  }
  function makeFiddleLeaf(tile){
    const { tctx:g } = tile;
    const trunks = [ [TILE_PX*0.5, TILE_PX*0.78] ];
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      trunks.forEach(([bx,by])=>{
        drawStem(g,bx,by,bx,by-26,PAL.stem);
        for(let i=0;i<6;i++){
          const y=by-6-i*4, dir=i%2?-1:1;
          const a = dir*0.9 + Math.sin(time*0.003+i)*0.15 + Math.sin(windA)*0.2*windMag;
          drawLeaf(g, bx, y, 12, 4, a, PAL.leafDark, PAL.leafLight);
        }
      });
    };
  }
  function makeMonstera(tile){
    const { tctx:g } = tile;
    const cx=TILE_PX*0.5, cy=TILE_PX*0.68;
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      for(let i=0;i<4;i++){
        const a = -Math.PI/2 + (i-1.5)*0.5;
        const cut = 3 + i;
        const bend = Math.sin(time*0.002+i)*0.2 + Math.cos(windA-a)*0.2*windMag;
        const steps = 24, len=28, width=6, ang=a+bend;
        for(let s=0;s<=steps;s++){
          const t=s/steps;
          const dx = Math.cos(ang)*len*t, dy=Math.sin(ang)*len*t;
          const w = width*(1 - Math.pow(t,1.4));
          for(let k=-w;k<=w;k++){
            if (Math.abs(k)<1 && t>0.3 && (s%cut===0)) continue;
            px(g, cx+dx+k, cy+dy, 1,1, k===0?PAL.leaf:PAL.leafLight);
          }
        }
        drawStem(g, cx, cy, cx+Math.cos(a)*14, cy+Math.sin(a)*14, PAL.stem);
      }
    };
  }
  function makeBougainvillea(tile){
    const { tctx:g } = tile;
    const cx=TILE_PX*0.48, cy=TILE_PX*0.72;
    return (time, windA, windMag)=>{
      g.clearRect(0,0,TILE_PX,TILE_PX);
      for(let b=0;b<3;b++){
        const a = -Math.PI/2 + (b-1)*0.4 + Math.sin(time*0.003+b)*0.12 + Math.cos(windA)*0.15*windMag;
        drawStem(g,cx,cy,cx+Math.cos(a)*18, cy+Math.sin(a)*18, PAL.stem);
        for(let i=0;i<7;i++){
          const t=i/7, x=cx+Math.cos(a)*18*t, y=cy+Math.sin(a)*18*t;
          drawLeaf(g,x,y,9,2,a+Math.PI/2, PAL.leafDark, PAL.leafLight);
          if (i%3===1) px(g, x+1, y-1, 2,2, PAL.bloom);
        }
      }
    };
  }

  const foliageMakers = [
    makePalmFronds,
    makeBroadleafCluster,
    makeFern,
    makeBamboo,
    makeVines,
    makeBanana,
    makeBush,
    makePhilodendron,
    makeReeds,
    makeFiddleLeaf,
    makeMonstera,
    makeBougainvillea,
  ];

  // Tiles + gib state
  const tiles = [];
  for (let r=0;r<ROWS;r++){
    for (let c=0;c<COLS;c++){
      const tile = makeTileCanvas();
      const idx = r*COLS + c;
      const maker = foliageMakers[idx % foliageMakers.length];
      tile.update = maker(tile, idx);

      // gib particles store (in world coords)
      tile.gib = { active:false, parts:[] };
      tiles.push(tile);
    }
  }

  // Helpers for drawing
  function drawTile(t, x, y, scale){
    const w = t.c.width, h = t.c.height;
    ctx.save();
    ctx.translate(x, y);
    ctx.scale(scale, scale);
    ctx.drawImage(t.c, 0, 0);
    ctx.restore();
  }
  function drawGridBackdrop() {
    ctx.save();
    ctx.globalAlpha = 0.08;
    ctx.fillStyle = '#000';
    for (let i = 0; i <= W; i += 32) ctx.fillRect(i, 0, 1, H);
    for (let j = 0; j <= H; j += 32) ctx.fillRect(0, j, W, 1);
    ctx.restore();
    const grd = ctx.createRadialGradient(W/2,H/2,Math.min(W,H)*0.2, W/2,H/2, Math.max(W,H)*0.7);
    grd.addColorStop(0,'rgba(0,0,0,0)');
    grd.addColorStop(1,'rgba(0,0,0,0.6)');
    ctx.fillStyle = grd; ctx.fillRect(0,0,W,H);
  }

  // Particle creation from a tile image
  function gibTile(tile, worldX, worldY){
    if (tile.gib.active) return;
    const SAMPLE = 2;
    const data = tile.tctx.getImageData(0,0,TILE_PX,TILE_PX).data;
    const parts = [];
    const cx = TILE_PX/2, cy = TILE_PX/2;
    for (let y=0; y<TILE_PX; y+=SAMPLE){
      for (let x=0; x<TILE_PX; x+=SAMPLE){
        const idx = (y*TILE_PX + x)*4;
        const a = data[idx+3];
        if (a < 10) continue;
        const r = data[idx], g = data[idx+1], b = data[idx+2];
        const dx = x - cx, dy = y - cy;
        const dist = Math.max(10, Math.hypot(dx,dy));
        const n = { x: dx/dist, y: dy/dist };
        const speed = 200 + Math.random()*240;
        const vx = n.x*speed + (Math.random()-0.5)*120;
        const vy = n.y*speed + (Math.random()-0.5)*120 - 60;
        parts.push({
          x: worldX + x*SCALE, y: worldY + y*SCALE,
          vx, vy, w:SCALE*SAMPLE, h:SCALE*SAMPLE,
          life: 1.3*(0.6+Math.random()*0.6), age:0,
          color:`rgba(${r},${g},${b},${a/255})`, spin:(Math.random()-0.5)*8, ang:0
        });
      }
    }
    tile.gib.active = true;
    tile.gib.parts = parts;
  }

  // Mouse click -> gib tile under cursor
  canvas.addEventListener('mousedown', (e)=>{
    const r = canvas.getBoundingClientRect();
    const mx = (e.clientX - r.left) * (canvas.width / r.width);
    const my = (e.clientY - r.top)  * (canvas.height / r.height);

    // compute wind + parallax positions to find tile bounds
    let index=0;
    for (let rr=0; rr<ROWS; rr++){
      for (let cc=0; cc<COLS; cc++){
        const tile = tiles[index++];
        const layer = (rr*COLS + cc) % 3;
        const par = [0.15, 0.3, 0.5][layer];
        const pxOff = -cam.x*par, pyOff = -cam.y*par;
        const x = startX + GAP + cc*(TILE_PX*SCALE + GAP) + pxOff;
        const y = startY + GAP + rr*(TILE_PX*SCALE + GAP) + pyOff;
        const w = TILE_PX*SCALE, h = TILE_PX*SCALE;
        if (mx>=x && mx<=x+w && my>=y && my<=y+h){
          gibTile(tile, x, y);
          return;
        }
      }
    }
  });

  // Keys: G = gib all, R = reset, P = recolor (kept)
  window.addEventListener('keydown', (e)=>{
    const k = e.key.toLowerCase();
    if (k==='g'){
      // gib all
      let index=0;
      for (let rr=0; rr<ROWS; rr++){
        for (let cc=0; cc<COLS; cc++){
          const tile = tiles[index++];
          const layer = (rr*COLS + cc) % 3;
          const par = [0.15, 0.3, 0.5][layer];
          const pxOff = -cam.x*par, pyOff = -cam.y*par;
          const x = startX + GAP + cc*(TILE_PX*SCALE + GAP) + pxOff;
          const y = startY + GAP + rr*(TILE_PX*SCALE + GAP) + pyOff;
          gibTile(tile, x, y);
        }
      }
    } else if (k==='r'){
      tiles.forEach(t=>{ t.gib.active=false; t.gib.parts.length=0; });
    } else if (k==='p'){
      PAL = randJunglePalette();
    }
  });

  // Main loop
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.033, (now-last)/1000); last = now;

    // WASD pan
    const fx = (keys.has('d')?1:0) + (keys.has('a')?-1:0);
    const fy = (keys.has('s')?1:0) + (keys.has('w')?-1:0);
    if (fx || fy){
      const ang = Math.atan2(fy, fx);
      cam.x += Math.cos(ang)*cam.speed*dt;
      cam.y += Math.sin(ang)*cam.speed*dt;
    }

    // Wind from mouse
    const dx = mouse.x - (W/2), dy = mouse.y - (H/2);
    const windAngle = Math.atan2(dy, dx);
    const windMag = clamp(Math.hypot(dx,dy) / (Math.max(W,H)*0.5), 0, 1);

    // Clear + backdrop
    ctx.clearRect(0,0,W,H);
    drawGridBackdrop();

    // Draw tiles or their gibs with slight parallax
    let index=0;
    for (let r=0;r<ROWS;r++){
      for (let c=0;c<COLS;c++){
        const tile = tiles[index++];

        // Update plant image if not gibbed
        if (!tile.gib.active){
          tile.update(now, windAngle, windMag);
        }

        const layer = (r*COLS + c) % 3;
        const par = [0.15, 0.3, 0.5][layer];
        const pxOff = -cam.x*par, pyOff = -cam.y*par;

        const x = startX + GAP + c*(TILE_PX*SCALE + GAP) + pxOff;
        const y = startY + GAP + r*(TILE_PX*SCALE + GAP) + pyOff;

        // card
        ctx.save();
        ctx.translate(x-4, y-4);
        ctx.fillStyle = 'rgba(255,255,255,0.03)';
        ctx.fillRect(0,0,TILE_PX*SCALE+8, TILE_PX*SCALE+8);
        ctx.strokeStyle = 'rgba(255,255,255,0.06)';
        ctx.strokeRect(0.5,0.5,TILE_PX*SCALE+7, TILE_PX*SCALE+7);
        ctx.restore();

        if (!tile.gib.active){
          drawTile(tile, x, y, SCALE);
        } else {
          // animate particles
          const parts = tile.gib.parts;
          const GRAV = 900;
          const DRAG = 0.985;

          // physics + draw
          for (let i=0;i<parts.length;i++){
            const p = parts[i];
            p.vy += GRAV*dt;
            p.vx *= DRAG; p.vy *= DRAG;
            p.x += p.vx*dt; p.y += p.vy*dt;
            p.ang += p.spin*dt;
            p.age += dt;
          }

          for (let i=0;i<parts.length;i++){
            const p = parts[i];
            const t = Math.max(0, 1 - p.age/p.life);
            if (t<=0) continue;
            ctx.save();
            ctx.globalAlpha = t;
            ctx.translate(p.x + p.w/2, p.y + p.h/2);
            ctx.rotate(p.ang*0.1);
            ctx.fillStyle = p.color;
            ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
            ctx.restore();
          }

          // auto-finish when done
          if (!parts.some(p=>p.age < p.life)){
            tile.gib.active = false;
            tile.gib.parts.length = 0;
          }
        }
      }
    }

    requestAnimationFrame(loop);
  }
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
